<!DOCTYPE html>
<html lang="en" data-accent-color="lime" data-content_root="../../../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>icspacket.proto.dnp3.master - icspacket 0.1.dev1+g2b18a0cc4 documentation</title><link rel="index" title="Index" href="../../../../genindex.html" /><link rel="search" title="Search" href="../../../../search.html" />
      <link rel="canonical" href="https://matrixeditor.github.io/icspacket/_modules/icspacket/proto/dnp3/master.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"dark");
  </script><link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/shibuya.css?v=d48c410d" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/>
<meta property="og:url" content="https://matrixeditor.github.io/icspacket/_modules/icspacket/proto/dnp3/master.html"/>
<meta property="og:title" content="icspacket.proto.dnp3.master"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../../../index.html">
      
      
      <strong>icspacket</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"><ul>
      <li class="link"><a class="js-menu" href="../../../../getting-started/protocols.html" id="nav-trigger-1" aria-controls="nav-children-1">
            <span>Examples</span>
            <i class="i-lucide chevron-down"></i>
          </a>
        <ul id="nav-children-1" aria-labelledby="nav-trigger-1"><li><a href="../../../../protocols/mms/examples.html">
                <span>MMS Utilities</span>
                <small>Manufacturing Message Specification tools</small>
              </a></li><li><a href="../../../../protocols/dnp3/examples.html">
                <span>DNP3 Tools</span>
                <small>DNP3 utilities and tools</small>
              </a></li></ul>
      </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials">
  <a href="https://github.com/MatrixEditor/icspacket" aria-label="GitHub">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </a></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6"><div class="sidebar-links">
  <ul>
    <li><a class="icon-link" href="https://github.com/MatrixEditor/icspacket/discussions">
  <span class="icon">
    <svg viewBox="0 0 24 24" fill="none">
      <path fill="var(--accent-9)" fill-rule="evenodd" clip-rule="evenodd" d="M11 5a6 6 0 0 0-4.687 9.746c.215.27.315.62.231.954l-.514 2.058a1 1 0 0 0 1.485 1.1l2.848-1.71c.174-.104.374-.15.576-.148H13a6 6 0 0 0 0-12h-2Z"/>
      <circle fill="white" cx="12" cy="11" r="1"/>
      <circle fill="white" cx="9" cy="11" r="1"/>
      <circle fill="white" cx="15" cy="11" r="1"/>
    </svg>
  </span>
  <span class="text">Discussion</span>
</a></li>
  </ul>
</div>
        <div class="globaltoc" data-expand-depth="2"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../getting-started/installation.html">Installation</a></li>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../getting-started/protocols.html">Protocols Overview</a></li>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../getting-started/coreapi.html">Core API Reference</a></li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">DNP3 / IEEE 1815</span></p>
<ul>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../protocols/dnp3/dnp3dump.html">Dumping Objects</a></li>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../protocols/dnp3/api.html">API Reference</a><ul>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/dnp3/api/link.html">Link Layer</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/dnp3/api/transport.html">Transport Layer</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/dnp3/api/application.html">Application Layer</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/dnp3/api/master.html">Master</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/dnp3/api/object_library.html">Object Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols/dnp3/api/primitives.html">Primitive Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols/dnp3/api/coding.html">Encoding / Decoding</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols/dnp3/api/variations.html">Variations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols/dnp3/api/coding_utils.html">Object Utilities</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">MMS / ISO 9506</span></p>
<ul>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../protocols/mms/demo_vars.html">Variable Target Format</a></li>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../protocols/mms/demo_vars.html#variableaccess-service-rwq">VariableAccess Service (rwq)</a></li>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../protocols/mms/demo_files.html">FileManagement Service</a></li>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../protocols/mms/api.html">API Reference</a><ul>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/mms/api_conn.html">MMS Connection</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/mms/api_data.html">Data Conversion</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/mms/api_utils.html">Protocol Utilities</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">ACSE / X.227</span></p>
<ul>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../protocols/acse/api.html">API Reference</a></li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">COPP / X.226 / ISO 8823</span></p>
<ul>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../protocols/copp/api.html">API Reference</a><ul>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/copp/presentation.html">ISO Presentation</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/copp/utils.html">Protocol Utilities</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">COSP / X.225 / ISO 8237-1</span></p>
<ul>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../protocols/cosp/api.html">API Reference</a><ul>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/cosp/tsdu.html">TSDU</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/cosp/spdu.html">SPDU Types</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/cosp/values.html">Parameter Values (PV)</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/cosp/session.html">ISO Session</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/cosp/utils.html">Protocol Utilities</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">COTP / X.224</span></p>
<ul>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../protocols/cotp/api.html">API Reference</a><ul>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/cotp/structs.html">TPDU Types</a></li>
<li class="toctree-l2 _expand"><a class="reference internal" href="../../../../protocols/cotp/connection.html">Connection</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">TPKT Protocol (RFC1006)</span></p>
<ul>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../protocols/tpkt/usage.html">Using a TPKT Wrapper</a></li>
<li class="toctree-l1 _expand"><a class="reference internal" href="../../../../protocols/tpkt/api.html">API Reference</a></li>
</ul>
        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/MatrixEditor/icspacket"
  data-type="github" data-user="MatrixEditor" data-repo="icspacket">
  <span class="w-8 flex items-center justify-around shrink-0 text-3xl">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </span>
  <span class="flex-grow px-2 break-all">
    <span style="font-size: small;">MatrixEditor/icspacket</span>
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <iconify-icon icon="lucide:star"></iconify-icon>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <iconify-icon icon="lucide:git-fork"></iconify-icon>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../../../index.html"><span itemprop="name">icspacket</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">icspacket.proto.dnp3.master</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for icspacket.proto.dnp3.master</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="c1"># This file is part of icspacket.</span>
</span><span data-line="2"><span class="c1"># Copyright (C) 2025-present  MatrixEditor @ github</span>
</span><span data-line="3"><span class="c1">#</span>
</span><span data-line="4"><span class="c1"># This program is free software: you can redistribute it and/or modify</span>
</span><span data-line="5"><span class="c1"># it under the terms of the GNU General Public License as published by</span>
</span><span data-line="6"><span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span data-line="7"><span class="c1"># (at your option) any later version.</span>
</span><span data-line="8"><span class="c1">#</span>
</span><span data-line="9"><span class="c1"># This program is distributed in the hope that it will be useful,</span>
</span><span data-line="10"><span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span data-line="11"><span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
</span><span data-line="12"><span class="c1"># GNU General Public License for more details.</span>
</span><span data-line="13"><span class="c1">#</span>
</span><span data-line="14"><span class="c1"># You should have received a copy of the GNU General Public License</span>
</span><span data-line="15"><span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
</span><span data-line="16"><span class="kn">from</span><span class="w"> </span><span class="nn">curses</span><span class="w"> </span><span class="kn">import</span> <span class="n">noecho</span>
</span><span data-line="17"><span class="kn">from</span><span class="w"> </span><span class="nn">queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">Queue</span>
</span><span data-line="18"><span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
</span><span data-line="19"><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
</span><span data-line="20"><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span data-line="21">
</span><span data-line="22"><span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Collection</span>
</span><span data-line="23"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>
</span><span data-line="24"><span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">overload</span><span class="p">,</span> <span class="n">override</span>
</span><span data-line="25">
</span><span data-line="26"><span class="kn">from</span><span class="w"> </span><span class="nn">icspacket.core.connection</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConnectionNotEstablished</span><span class="p">,</span> <span class="n">connection</span>
</span><span data-line="27"><span class="kn">from</span><span class="w"> </span><span class="nn">icspacket.core.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">TRACE</span><span class="p">,</span> <span class="n">TRACE_PACKETS</span>
</span><span data-line="28"><span class="kn">from</span><span class="w"> </span><span class="nn">icspacket.core.hexdump</span><span class="w"> </span><span class="kn">import</span> <span class="n">hexdump</span>
</span><span data-line="29"><span class="kn">from</span><span class="w"> </span><span class="nn">icspacket.proto.dnp3.application</span><span class="w"> </span><span class="kn">import</span> <span class="n">APDU</span><span class="p">,</span> <span class="n">APDU_SEQ_MAX</span>
</span><span data-line="30"><span class="kn">from</span><span class="w"> </span><span class="nn">icspacket.proto.dnp3.const</span><span class="w"> </span><span class="kn">import</span> <span class="n">FunctionCode</span>
</span><span data-line="31"><span class="kn">from</span><span class="w"> </span><span class="nn">icspacket.proto.dnp3.link</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="32">    <span class="n">LPDU</span><span class="p">,</span>
</span><span data-line="33">    <span class="n">LinkDirection</span><span class="p">,</span>
</span><span data-line="34">    <span class="n">LinkPrimaryFunctionCode</span><span class="p">,</span>
</span><span data-line="35">    <span class="n">LinkSecondaryFunctionCode</span><span class="p">,</span>
</span><span data-line="36"><span class="p">)</span>
</span><span data-line="37"><span class="kn">from</span><span class="w"> </span><span class="nn">icspacket.proto.dnp3.transport</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="38">    <span class="n">TPDU</span><span class="p">,</span>
</span><span data-line="39">    <span class="n">TPDU_APPLICATION_MAX_LENGTH</span><span class="p">,</span>
</span><span data-line="40">    <span class="n">TPDU_SEQUENCE_MAX</span><span class="p">,</span>
</span><span data-line="41"><span class="p">)</span>
</span><span data-line="42"><span class="kn">from</span><span class="w"> </span><span class="nn">icspacket.proto.dnp3.objects.coding</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="43">    <span class="n">pack_objects</span><span class="p">,</span>
</span><span data-line="44">    <span class="n">unpack_objects</span><span class="p">,</span>
</span><span data-line="45">    <span class="n">DNP3Objects</span><span class="p">,</span>
</span><span data-line="46"><span class="p">)</span>
</span><span data-line="47">
</span><span data-line="48">
</span><span data-line="49"><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span data-line="50">
</span><span data-line="51">
</span><span data-line="52"><span class="n">_UnsolicitedResponseCallback</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">APDU</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
</span><span data-line="53"><span class="n">_APDUCallback</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;DNP3_Master&quot;</span><span class="p">,</span> <span class="n">APDU</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
</span><span data-line="54">
<div class="viewcode-block" id="DNP3_Task">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Task">[docs]</a>
</span><span data-line="55"><span class="k">class</span><span class="w"> </span><span class="nc">DNP3_Task</span><span class="p">:</span>
</span><span data-line="56"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for a DNP3 task.</span>
</span><span data-line="57">
</span><span data-line="58"><span class="sd">    A DNP3 task represents a unit of work that the Master initiates, such as</span>
</span><span data-line="59"><span class="sd">    sending a request and handling its response. Each task is responsible</span>
</span><span data-line="60"><span class="sd">    for preparing an APDU for transmission and for processing the received</span>
</span><span data-line="61"><span class="sd">    APDU messages once a response arrives.</span>
</span><span data-line="62">
</span><span data-line="63"><span class="sd">    Subclasses implement specific task behavior, such as blocking until</span>
</span><span data-line="64"><span class="sd">    a response is received or executing a callback when a response is</span>
</span><span data-line="65"><span class="sd">    available.</span>
</span><span data-line="66">
</span><span data-line="67"><span class="sd">    :ivar sequence: Application layer sequence number associated with the</span>
</span><span data-line="68"><span class="sd">        task. Initialized to ``-1`` and updated when the APDU is transmitted.</span>
</span><span data-line="69"><span class="sd">    :vartype sequence: int</span>
</span><span data-line="70"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="71">
</span><span data-line="72">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="73"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a new DNP3 task with an unset sequence number.&quot;&quot;&quot;</span>
</span><span data-line="74">        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span data-line="75">
<div class="viewcode-block" id="DNP3_Task.prepare_transmit">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Task.prepare_transmit">[docs]</a>
</span><span data-line="76">    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_transmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;DNP3_Master&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">APDU</span><span class="p">:</span>
</span><span data-line="77"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the APDU for transmission.</span>
</span><span data-line="78">
</span><span data-line="79"><span class="sd">        Subclasses must implement this to return the request APDU that will</span>
</span><span data-line="80"><span class="sd">        be sent to the outstation.</span>
</span><span data-line="81">
</span><span data-line="82"><span class="sd">        :param master: The DNP3 master instance initiating the transmission.</span>
</span><span data-line="83"><span class="sd">        :type master: DNP3_Master</span>
</span><span data-line="84"><span class="sd">        :return: The APDU to transmit.</span>
</span><span data-line="85"><span class="sd">        :rtype: APDU</span>
</span><span data-line="86"><span class="sd">        :raises NotImplementedError: If the method is not overridden in</span>
</span><span data-line="87"><span class="sd">            a subclass.</span>
</span><span data-line="88"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="89">        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

</span><span data-line="90">
<div class="viewcode-block" id="DNP3_Task.on_message">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Task.on_message">[docs]</a>
</span><span data-line="91">    <span class="k">def</span><span class="w"> </span><span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;DNP3_Master&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">APDU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="92"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle a received APDU message.</span>
</span><span data-line="93">
</span><span data-line="94"><span class="sd">        This is called when the Master receives a response APDU for the</span>
</span><span data-line="95"><span class="sd">        task. The default implementation does nothing.</span>
</span><span data-line="96">
</span><span data-line="97"><span class="sd">        :param master: The DNP3 master instance handling the message.</span>
</span><span data-line="98"><span class="sd">        :type master: DNP3_Master</span>
</span><span data-line="99"><span class="sd">        :param message: The received APDU response.</span>
</span><span data-line="100"><span class="sd">        :type message: APDU</span>
</span><span data-line="101"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="102">        <span class="k">pass</span></div>
</div>

</span><span data-line="103">
</span><span data-line="104">
</span><span data-line="105"><span class="k">class</span><span class="w"> </span><span class="nc">BlockingTask</span><span class="p">(</span><span class="n">DNP3_Task</span><span class="p">):</span>
</span><span data-line="106"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Blocking DNP3 task.</span>
</span><span data-line="107">
</span><span data-line="108"><span class="sd">    This task type blocks the caller until a response is received or the</span>
</span><span data-line="109"><span class="sd">    wait is interrupted. It is suitable for synchronous workflows where the</span>
</span><span data-line="110"><span class="sd">    Master must wait for the result before proceeding.</span>
</span><span data-line="111">
</span><span data-line="112"><span class="sd">    :ivar request: The request APDU to send to the outstation.</span>
</span><span data-line="113"><span class="sd">    :vartype request: APDU</span>
</span><span data-line="114"><span class="sd">    :ivar event: A threading event used to signal when a response has been</span>
</span><span data-line="115"><span class="sd">        received.</span>
</span><span data-line="116"><span class="sd">    :vartype event: threading.Event</span>
</span><span data-line="117"><span class="sd">    :ivar message: The response APDU received from the outstation. ``None``</span>
</span><span data-line="118"><span class="sd">        until a response is available.</span>
</span><span data-line="119"><span class="sd">    :vartype message: APDU | None</span>
</span><span data-line="120"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="121">
</span><span data-line="122">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">APDU</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="123"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a blocking task.</span>
</span><span data-line="124">
</span><span data-line="125"><span class="sd">        :param request: The request APDU to transmit.</span>
</span><span data-line="126"><span class="sd">        :type request: APDU</span>
</span><span data-line="127"><span class="sd">        :param event: The event object to notify when a response arrives.</span>
</span><span data-line="128"><span class="sd">        :type event: threading.Event</span>
</span><span data-line="129"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="130">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="131">        <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span>
</span><span data-line="132">        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
</span><span data-line="133">        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="134">
</span><span data-line="135">    <span class="nd">@override</span>
</span><span data-line="136">    <span class="k">def</span><span class="w"> </span><span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;DNP3_Master&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">APDU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="137"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Store the received message and notify the waiting thread.</span>
</span><span data-line="138">
</span><span data-line="139"><span class="sd">        :param master: The DNP3 master instance that received the message.</span>
</span><span data-line="140"><span class="sd">        :type master: DNP3_Master</span>
</span><span data-line="141"><span class="sd">        :param message: The received APDU.</span>
</span><span data-line="142"><span class="sd">        :type message: APDU</span>
</span><span data-line="143"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="144">        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
</span><span data-line="145">        <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span><span data-line="146">
</span><span data-line="147">    <span class="nd">@override</span>
</span><span data-line="148">    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_transmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;DNP3_Master&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">APDU</span><span class="p">:</span>
</span><span data-line="149"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the request APDU to be transmitted.</span>
</span><span data-line="150">
</span><span data-line="151"><span class="sd">        :param master: The DNP3 master instance initiating the transmission.</span>
</span><span data-line="152"><span class="sd">        :type master: DNP3_Master</span>
</span><span data-line="153"><span class="sd">        :return: The request APDU.</span>
</span><span data-line="154"><span class="sd">        :rtype: APDU</span>
</span><span data-line="155"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="156">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span>
</span><span data-line="157">
</span><span data-line="158">    <span class="k">def</span><span class="w"> </span><span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="159"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Block until the response event is set.</span>
</span><span data-line="160">
</span><span data-line="161"><span class="sd">        This method waits for the outstation&#39;s response to arrive.</span>
</span><span data-line="162"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="163">        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span><span data-line="164">
</span><span data-line="165">
</span><span data-line="166"><span class="k">class</span><span class="w"> </span><span class="nc">NonBlockingTask</span><span class="p">(</span><span class="n">DNP3_Task</span><span class="p">):</span>
</span><span data-line="167"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Non-blocking DNP3 task.</span>
</span><span data-line="168">
</span><span data-line="169"><span class="sd">    This task type does not block the caller. Instead, it uses a callback</span>
</span><span data-line="170"><span class="sd">    mechanism that is executed when a response APDU is received. This is</span>
</span><span data-line="171"><span class="sd">    suitable for asynchronous workflows or event-driven applications.</span>
</span><span data-line="172">
</span><span data-line="173"><span class="sd">    :ivar request: The request APDU to send to the outstation.</span>
</span><span data-line="174"><span class="sd">    :vartype request: APDU</span>
</span><span data-line="175"><span class="sd">    :ivar callback: Optional callback to be executed when a response is</span>
</span><span data-line="176"><span class="sd">        received. The callback receives the Master instance and the APDU</span>
</span><span data-line="177"><span class="sd">        as arguments.</span>
</span><span data-line="178"><span class="sd">    :vartype callback: _APDUCallback | None</span>
</span><span data-line="179"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="180">
</span><span data-line="181">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">APDU</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">_APDUCallback</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="182"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a non-blocking task.</span>
</span><span data-line="183">
</span><span data-line="184"><span class="sd">        :param request: The request APDU to transmit.</span>
</span><span data-line="185"><span class="sd">        :type request: APDU</span>
</span><span data-line="186"><span class="sd">        :param callback: The callback function to execute when a response is</span>
</span><span data-line="187"><span class="sd">            received. May be ``None`` if no callback is needed.</span>
</span><span data-line="188"><span class="sd">        :type callback: _APDUCallback | None</span>
</span><span data-line="189"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="190">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="191">        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
</span><span data-line="192">        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
</span><span data-line="193">
</span><span data-line="194">    <span class="nd">@override</span>
</span><span data-line="195">    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_transmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;DNP3_Master&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">APDU</span><span class="p">:</span>
</span><span data-line="196"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the request APDU to be transmitted.</span>
</span><span data-line="197">
</span><span data-line="198"><span class="sd">        :param master: The DNP3 master instance initiating the transmission.</span>
</span><span data-line="199"><span class="sd">        :type master: DNP3_Master</span>
</span><span data-line="200"><span class="sd">        :return: The request APDU.</span>
</span><span data-line="201"><span class="sd">        :rtype: APDU</span>
</span><span data-line="202"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="203">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span>
</span><span data-line="204">
</span><span data-line="205">    <span class="nd">@override</span>
</span><span data-line="206">    <span class="k">def</span><span class="w"> </span><span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;DNP3_Master&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">APDU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="207"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Invoke the callback with the received APDU.</span>
</span><span data-line="208">
</span><span data-line="209"><span class="sd">        If a callback is defined, it is executed with the Master instance and</span>
</span><span data-line="210"><span class="sd">        the received APDU. Any exceptions raised in the callback are caught</span>
</span><span data-line="211"><span class="sd">        and logged.</span>
</span><span data-line="212">
</span><span data-line="213"><span class="sd">        :param master: The DNP3 master instance that received the message.</span>
</span><span data-line="214"><span class="sd">        :type master: DNP3_Master</span>
</span><span data-line="215"><span class="sd">        :param message: The received APDU response.</span>
</span><span data-line="216"><span class="sd">        :type message: APDU</span>
</span><span data-line="217"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="218">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="219">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">:</span>
</span><span data-line="220">                <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span><span data-line="221">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="222">            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span data-line="223">
</span><span data-line="224">
<div class="viewcode-block" id="DNP3_Link">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Link">[docs]</a>
</span><span data-line="225"><span class="k">class</span><span class="w"> </span><span class="nc">DNP3_Link</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
</span><span data-line="226"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Implements the DNP3 Link Layer.</span>
</span><span data-line="227">
</span><span data-line="228"><span class="sd">    The Link Layer provides reliable delivery of Link Protocol Data Units (LPDUs)</span>
</span><span data-line="229"><span class="sd">    between a DNP3 master and outstation over a transport medium such as TCP.</span>
</span><span data-line="230"><span class="sd">    This class is responsible for:</span>
</span><span data-line="231">
</span><span data-line="232"><span class="sd">    - Encapsulation of octet streams into LPDUs.</span>
</span><span data-line="233"><span class="sd">    - Validation of source/destination addresses.</span>
</span><span data-line="234"><span class="sd">    - Handling link-layer function codes (e.g., `UNCONFIRMED_USER_DATA`,</span>
</span><span data-line="235"><span class="sd">      `REQUEST_LINK_STATUS`, `LINK_STATUS`, `NOT_SUPPORTED`).</span>
</span><span data-line="236"><span class="sd">    - Forwarding valid user data to the upper layer.</span>
</span><span data-line="237">
</span><span data-line="238"><span class="sd">    The class maintains an internal input queue of received LPDUs that have</span>
</span><span data-line="239"><span class="sd">    passed validation and are intended for the upper layers.</span>
</span><span data-line="240">
</span><span data-line="241"><span class="sd">    :param src: The source link-layer address of this endpoint.</span>
</span><span data-line="242"><span class="sd">    :type src: int</span>
</span><span data-line="243"><span class="sd">    :param dst: The expected destination address of the remote peer.</span>
</span><span data-line="244"><span class="sd">    :type dst: int</span>
</span><span data-line="245"><span class="sd">    :param sock: Optional pre-initialized TCP socket. If ``None``, a new</span>
</span><span data-line="246"><span class="sd">        socket will be created.</span>
</span><span data-line="247"><span class="sd">    :type sock: socket.socket | None</span>
</span><span data-line="248"><span class="sd">    :param mode: Link direction, either MASTER or OUTSTATION.</span>
</span><span data-line="249"><span class="sd">    :type mode: LinkDirection</span>
</span><span data-line="250"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="251">
</span><span data-line="252">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="253">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="254">        <span class="n">src</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="255">        <span class="n">dst</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span data-line="256">        <span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="257">        <span class="n">mode</span><span class="p">:</span> <span class="n">LinkDirection</span> <span class="o">=</span> <span class="n">LinkDirection</span><span class="o">.</span><span class="n">MASTER</span><span class="p">,</span>
</span><span data-line="258">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="259">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="260">        <span class="bp">self</span><span class="o">.</span><span class="n">__src</span> <span class="o">=</span> <span class="n">src</span>
</span><span data-line="261">        <span class="bp">self</span><span class="o">.</span><span class="n">__dst</span> <span class="o">=</span> <span class="n">dst</span>
</span><span data-line="262">        <span class="bp">self</span><span class="o">.</span><span class="n">__dir</span> <span class="o">=</span> <span class="n">mode</span>
</span><span data-line="263">        <span class="bp">self</span><span class="o">.</span><span class="n">__in_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
</span><span data-line="264">
</span><span data-line="265">        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">sock</span>
</span><span data-line="266">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
</span><span data-line="267">            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span data-line="268">
</span><span data-line="269">    <span class="nd">@property</span>
</span><span data-line="270">    <span class="k">def</span><span class="w"> </span><span class="nf">in_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Queue</span><span class="p">[</span><span class="n">LPDU</span><span class="p">]:</span>
</span><span data-line="271"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Queue of validated inbound LPDUs.</span>
</span><span data-line="272">
</span><span data-line="273"><span class="sd">        Only LPDUs that pass address and direction checks are placed into</span>
</span><span data-line="274"><span class="sd">        this queue for higher-layer consumption.</span>
</span><span data-line="275">
</span><span data-line="276"><span class="sd">        :rtype: Queue[LPDU]</span>
</span><span data-line="277"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="278">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__in_queue</span>
</span><span data-line="279">
</span><span data-line="280">    <span class="nd">@property</span>
</span><span data-line="281">    <span class="k">def</span><span class="w"> </span><span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LinkDirection</span><span class="p">:</span>
</span><span data-line="282"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Link direction of this endpoint.</span>
</span><span data-line="283">
</span><span data-line="284"><span class="sd">        :rtype: LinkDirection</span>
</span><span data-line="285"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="286">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dir</span>
</span><span data-line="287">
</span><span data-line="288">    <span class="nd">@property</span>
</span><span data-line="289">    <span class="k">def</span><span class="w"> </span><span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span data-line="290"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The source address of this endpoint.</span>
</span><span data-line="291">
</span><span data-line="292"><span class="sd">        :rtype: int</span>
</span><span data-line="293"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="294">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__src</span>
</span><span data-line="295">
</span><span data-line="296">    <span class="nd">@property</span>
</span><span data-line="297">    <span class="k">def</span><span class="w"> </span><span class="nf">destination</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span data-line="298"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The expected destination address of the peer.</span>
</span><span data-line="299">
</span><span data-line="300"><span class="sd">        :rtype: int</span>
</span><span data-line="301"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="302">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dst</span>
</span><span data-line="303">
<div class="viewcode-block" id="DNP3_Link.send_data">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Link.send_data">[docs]</a>
</span><span data-line="304">    <span class="k">def</span><span class="w"> </span><span class="nf">send_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">octets</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="305"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Send user data as an unconfirmed LPDU.</span>
</span><span data-line="306">
</span><span data-line="307"><span class="sd">        The octets are wrapped into a Link Layer frame with the</span>
</span><span data-line="308"><span class="sd">        function code `UNCONFIRMED_USER_DATA` and transmitted.</span>
</span><span data-line="309">
</span><span data-line="310"><span class="sd">        :param octets: The application/user data to send.</span>
</span><span data-line="311"><span class="sd">        :type octets: bytes</span>
</span><span data-line="312"><span class="sd">        :raises ConnectionError: If the socket is not connected.</span>
</span><span data-line="313"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="314">        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_connected</span><span class="p">()</span>
</span><span data-line="315">        <span class="n">lpdu</span> <span class="o">=</span> <span class="n">LPDU</span><span class="p">()</span>
</span><span data-line="316">        <span class="n">lpdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">function_code</span> <span class="o">=</span> <span class="n">LinkPrimaryFunctionCode</span><span class="o">.</span><span class="n">UNCONFIRMED_USER_DATA</span>
</span><span data-line="317">        <span class="n">lpdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">LinkDirection</span><span class="o">.</span><span class="n">MASTER</span>
</span><span data-line="318">        <span class="n">lpdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">primary_message</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="319">        <span class="n">lpdu</span><span class="o">.</span><span class="n">user_data</span> <span class="o">=</span> <span class="n">octets</span>
</span><span data-line="320">        <span class="bp">self</span><span class="o">.</span><span class="n">send_lpdu</span><span class="p">(</span><span class="n">lpdu</span><span class="p">)</span></div>

</span><span data-line="321">
<div class="viewcode-block" id="DNP3_Link.send_lpdu">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Link.send_lpdu">[docs]</a>
</span><span data-line="322">    <span class="k">def</span><span class="w"> </span><span class="nf">send_lpdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lpdu</span><span class="p">:</span> <span class="n">LPDU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="323"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a fully constructed LPDU.</span>
</span><span data-line="324">
</span><span data-line="325"><span class="sd">        This method sets the LPDU&#39;s source and destination before</span>
</span><span data-line="326"><span class="sd">        serializing and transmitting it over the socket.</span>
</span><span data-line="327">
</span><span data-line="328"><span class="sd">        :param lpdu: The LPDU to send.</span>
</span><span data-line="329"><span class="sd">        :type lpdu: LPDU</span>
</span><span data-line="330"><span class="sd">        :raises ConnectionError: If the socket is not connected.</span>
</span><span data-line="331"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="332">        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_connected</span><span class="p">()</span>
</span><span data-line="333">        <span class="n">lpdu</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
</span><span data-line="334">        <span class="n">lpdu</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">destination</span>
</span><span data-line="335">        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">lpdu</span><span class="o">.</span><span class="n">build</span><span class="p">())</span></div>

</span><span data-line="336">
<div class="viewcode-block" id="DNP3_Link.recv_data">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Link.recv_data">[docs]</a>
</span><span data-line="337">    <span class="k">def</span><span class="w"> </span><span class="nf">recv_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span data-line="338"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Receive raw LPDU octets from the socket.</span>
</span><span data-line="339">
</span><span data-line="340"><span class="sd">        Reads up to 292 bytes, which is the maximum LPDU size</span>
</span><span data-line="341"><span class="sd">        (per Link Layer specification, length field max 255</span>
</span><span data-line="342"><span class="sd">        plus headers).</span>
</span><span data-line="343">
</span><span data-line="344"><span class="sd">        :return: Raw bytes read from the socket.</span>
</span><span data-line="345"><span class="sd">        :rtype: bytes</span>
</span><span data-line="346"><span class="sd">        :raises ConnectionError: If the socket is not connected.</span>
</span><span data-line="347"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="348">        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_connected</span><span class="p">()</span>
</span><span data-line="349">        <span class="c1"># from Link Layer 9.2.4.1.2 LENGTH field</span>
</span><span data-line="350">        <span class="c1"># The minimum value for this field is 5, indicating only the header is</span>
</span><span data-line="351">        <span class="c1"># present, and the maximum value is 255. The maximum length however is</span>
</span><span data-line="352">        <span class="c1"># always 292</span>
</span><span data-line="353">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">292</span><span class="p">)</span></div>

</span><span data-line="354">
<div class="viewcode-block" id="DNP3_Link.send_link_status">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Link.send_link_status">[docs]</a>
</span><span data-line="355">    <span class="k">def</span><span class="w"> </span><span class="nf">send_link_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="356"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a link status response.</span>
</span><span data-line="357">
</span><span data-line="358"><span class="sd">        Constructs an LPDU with function code `LINK_STATUS`</span>
</span><span data-line="359"><span class="sd">        and transmits it.</span>
</span><span data-line="360">
</span><span data-line="361"><span class="sd">        :raises ConnectionError: If the socket is not connected.</span>
</span><span data-line="362"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="363">        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_connected</span><span class="p">()</span>
</span><span data-line="364">        <span class="n">lpdu</span> <span class="o">=</span> <span class="n">LPDU</span><span class="p">()</span>
</span><span data-line="365">        <span class="n">lpdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">function_code</span> <span class="o">=</span> <span class="n">LinkSecondaryFunctionCode</span><span class="o">.</span><span class="n">LINK_STATUS</span>
</span><span data-line="366">        <span class="n">lpdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">LinkDirection</span><span class="o">.</span><span class="n">MASTER</span>
</span><span data-line="367">        <span class="n">lpdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">primary_message</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="368">        <span class="bp">self</span><span class="o">.</span><span class="n">send_lpdu</span><span class="p">(</span><span class="n">lpdu</span><span class="p">)</span></div>

</span><span data-line="369">
<div class="viewcode-block" id="DNP3_Link.send_not_supported">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Link.send_not_supported">[docs]</a>
</span><span data-line="370">    <span class="k">def</span><span class="w"> </span><span class="nf">send_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="371"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a &#39;Not Supported&#39; response.</span>
</span><span data-line="372">
</span><span data-line="373"><span class="sd">        Constructs an LPDU with function code `NOT_SUPPORTED`</span>
</span><span data-line="374"><span class="sd">        and transmits it.</span>
</span><span data-line="375">
</span><span data-line="376"><span class="sd">        :raises ConnectionError: If the socket is not connected.</span>
</span><span data-line="377"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="378">        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_connected</span><span class="p">()</span>
</span><span data-line="379">        <span class="n">lpdu</span> <span class="o">=</span> <span class="n">LPDU</span><span class="p">()</span>
</span><span data-line="380">        <span class="n">lpdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">function_code</span> <span class="o">=</span> <span class="n">LinkSecondaryFunctionCode</span><span class="o">.</span><span class="n">NOT_SUPPORTED</span>
</span><span data-line="381">        <span class="n">lpdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">LinkDirection</span><span class="o">.</span><span class="n">MASTER</span>
</span><span data-line="382">        <span class="n">lpdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">primary_message</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="383">        <span class="bp">self</span><span class="o">.</span><span class="n">send_lpdu</span><span class="p">(</span><span class="n">lpdu</span><span class="p">)</span></div>

</span><span data-line="384">
</span><span data-line="385">    <span class="k">def</span><span class="w"> </span><span class="nf">_process_lpdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lpdu</span><span class="p">:</span> <span class="n">LPDU</span><span class="p">,</span> <span class="n">raw_octets</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span data-line="386"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate and process a received LPDU.</span>
</span><span data-line="387">
</span><span data-line="388"><span class="sd">        Performs address and direction checks. Depending on the function</span>
</span><span data-line="389"><span class="sd">        code, the LPDU may be forwarded to the upper layer, trigger a</span>
</span><span data-line="390"><span class="sd">        link-status response, or a not-supported response.</span>
</span><span data-line="391">
</span><span data-line="392"><span class="sd">        :param lpdu: The parsed LPDU.</span>
</span><span data-line="393"><span class="sd">        :type lpdu: LPDU</span>
</span><span data-line="394"><span class="sd">        :param raw_octets: The raw octets from which the LPDU was parsed.</span>
</span><span data-line="395"><span class="sd">        :type raw_octets: bytes</span>
</span><span data-line="396"><span class="sd">        :return: ``True`` if the LPDU should be forwarded to the upper layer,</span>
</span><span data-line="397"><span class="sd">            ``False`` otherwise.</span>
</span><span data-line="398"><span class="sd">        :rtype: bool</span>
</span><span data-line="399"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="400">        <span class="k">if</span> <span class="n">lpdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
</span><span data-line="401">            <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span data-line="402">                <span class="n">TRACE</span><span class="p">,</span>
</span><span data-line="403">                <span class="s2">&quot;[LINK] Received master-to-master LPDU&quot;</span>
</span><span data-line="404">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LinkDirection</span><span class="o">.</span><span class="n">MASTER</span>
</span><span data-line="405">                <span class="k">else</span> <span class="s2">&quot;Received secondary-to-secondary LPDU&quot;</span><span class="p">,</span>
</span><span data-line="406">                <span class="n">lpdu</span><span class="p">,</span>
</span><span data-line="407">            <span class="p">)</span>
</span><span data-line="408">            <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="409">
</span><span data-line="410">        <span class="k">if</span> <span class="n">lpdu</span><span class="o">.</span><span class="n">destination</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
</span><span data-line="411">            <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span data-line="412">                <span class="n">TRACE</span><span class="p">,</span>
</span><span data-line="413">                <span class="s2">&quot;[LINK] Received unexpected LPDU with destination address </span><span class="si">%#04x</span><span class="s2">, expected </span><span class="si">%#04x</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span data-line="414">                <span class="n">lpdu</span><span class="o">.</span><span class="n">destination</span><span class="p">,</span>
</span><span data-line="415">                <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
</span><span data-line="416">            <span class="p">)</span>
</span><span data-line="417">            <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="418">
</span><span data-line="419">        <span class="k">if</span> <span class="n">lpdu</span><span class="o">.</span><span class="n">source</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">:</span>
</span><span data-line="420">            <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span data-line="421">                <span class="n">TRACE</span><span class="p">,</span>
</span><span data-line="422">                <span class="s2">&quot;[LINK] Received unexpected LPDU with source address </span><span class="si">%#04x</span><span class="s2">, expected </span><span class="si">%#04x</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span data-line="423">                <span class="n">lpdu</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
</span><span data-line="424">                <span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">,</span>
</span><span data-line="425">            <span class="p">)</span>
</span><span data-line="426">            <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="427">
</span><span data-line="428">        <span class="n">code</span> <span class="o">=</span> <span class="n">lpdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">pri2sec_code</span>
</span><span data-line="429">        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span data-line="430">            <span class="n">TRACE_PACKETS</span><span class="p">,</span>
</span><span data-line="431">            <span class="s2">&quot;[LINK] Received secondary-to-master LPDU with code </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span data-line="432">            <span class="n">code</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span data-line="433">            <span class="n">hexdump</span><span class="p">(</span><span class="n">raw_octets</span><span class="p">),</span>
</span><span data-line="434">        <span class="p">)</span>
</span><span data-line="435">        <span class="k">match</span> <span class="n">code</span><span class="p">:</span>
</span><span data-line="436">            <span class="k">case</span> <span class="n">LinkPrimaryFunctionCode</span><span class="o">.</span><span class="n">UNCONFIRMED_USER_DATA</span><span class="p">:</span>
</span><span data-line="437">                <span class="k">return</span> <span class="kc">True</span>
</span><span data-line="438">            <span class="k">case</span> <span class="n">LinkPrimaryFunctionCode</span><span class="o">.</span><span class="n">REQUEST_LINK_STATUS</span><span class="p">:</span>
</span><span data-line="439">                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s2">&quot;Peer requested link status&quot;</span><span class="p">)</span>
</span><span data-line="440">                <span class="bp">self</span><span class="o">.</span><span class="n">send_link_status</span><span class="p">()</span>
</span><span data-line="441">            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span data-line="442">                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span data-line="443">                    <span class="n">TRACE_PACKETS</span><span class="p">,</span>
</span><span data-line="444">                    <span class="s2">&quot;Function code &lt;</span><span class="si">%s</span><span class="s2">&gt; not supported:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span data-line="445">                    <span class="n">hexdump</span><span class="p">(</span><span class="n">raw_octets</span><span class="p">),</span>
</span><span data-line="446">                <span class="p">)</span>
</span><span data-line="447">                <span class="bp">self</span><span class="o">.</span><span class="n">send_not_supported</span><span class="p">()</span>
</span><span data-line="448">        <span class="k">return</span> <span class="kc">False</span>
</span><span data-line="449">
<div class="viewcode-block" id="DNP3_Link.recv_lpdu">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Link.recv_lpdu">[docs]</a>
</span><span data-line="450">    <span class="k">def</span><span class="w"> </span><span class="nf">recv_lpdu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LPDU</span><span class="p">:</span>
</span><span data-line="451"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Receive and parse the next valid LPDU.</span>
</span><span data-line="452">
</span><span data-line="453"><span class="sd">        This method handles fragmented reception (multiple LPDUs in</span>
</span><span data-line="454"><span class="sd">        one read) and incomplete frames. Valid frames that pass link</span>
</span><span data-line="455"><span class="sd">        validation are placed in the inbound queue.</span>
</span><span data-line="456">
</span><span data-line="457"><span class="sd">        :return: The next valid LPDU for the upper layer.</span>
</span><span data-line="458"><span class="sd">        :rtype: LPDU</span>
</span><span data-line="459"><span class="sd">        :raises ConnectionError: If the socket is not connected.</span>
</span><span data-line="460"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="461">        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span data-line="462">            <span class="n">octets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv_data</span><span class="p">()</span>
</span><span data-line="463">            <span class="n">length</span> <span class="o">=</span> <span class="n">LPDU</span><span class="o">.</span><span class="n">full_length</span><span class="p">(</span><span class="n">octets</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span data-line="464">
</span><span data-line="465">            <span class="n">raw_first_lpdu</span> <span class="o">=</span> <span class="n">octets</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span>
</span><span data-line="466">            <span class="n">lpdu</span> <span class="o">=</span> <span class="n">LPDU</span><span class="o">.</span><span class="n">from_octets</span><span class="p">(</span><span class="n">raw_first_lpdu</span><span class="p">)</span>
</span><span data-line="467">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_lpdu</span><span class="p">(</span><span class="n">lpdu</span><span class="p">,</span> <span class="n">raw_first_lpdu</span><span class="p">):</span>
</span><span data-line="468">                <span class="bp">self</span><span class="o">.</span><span class="n">in_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">lpdu</span><span class="p">)</span>
</span><span data-line="469">
</span><span data-line="470">            <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">octets</span><span class="p">):</span>
</span><span data-line="471">                <span class="k">continue</span>
</span><span data-line="472">
</span><span data-line="473">            <span class="n">remaining</span> <span class="o">=</span> <span class="n">octets</span><span class="p">[</span><span class="n">length</span><span class="p">:]</span>
</span><span data-line="474">            <span class="n">remaining_full_length</span> <span class="o">=</span> <span class="n">LPDU</span><span class="o">.</span><span class="n">full_length</span><span class="p">(</span><span class="n">remaining</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span data-line="475">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">remaining_full_length</span><span class="p">:</span>
</span><span data-line="476">                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span data-line="477">                    <span class="n">TRACE</span><span class="p">,</span>
</span><span data-line="478">                    <span class="s2">&quot;[LINK] Received incomplete second LPDU with expected length </span><span class="si">%d</span><span class="s2">, current length </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span data-line="479">                    <span class="n">remaining_full_length</span><span class="p">,</span>
</span><span data-line="480">                    <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">),</span>
</span><span data-line="481">                <span class="p">)</span>
</span><span data-line="482">                <span class="n">raw_second_lpdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">remaining_full_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">))</span>
</span><span data-line="483">                <span class="n">raw_second_lpdu</span> <span class="o">=</span> <span class="n">remaining</span> <span class="o">+</span> <span class="n">raw_second_lpdu</span>
</span><span data-line="484">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="485">                <span class="n">raw_second_lpdu</span> <span class="o">=</span> <span class="n">remaining</span>
</span><span data-line="486">
</span><span data-line="487">            <span class="n">lpdu</span> <span class="o">=</span> <span class="n">LPDU</span><span class="o">.</span><span class="n">from_octets</span><span class="p">(</span><span class="n">raw_second_lpdu</span><span class="p">)</span>
</span><span data-line="488">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_lpdu</span><span class="p">(</span><span class="n">lpdu</span><span class="p">,</span> <span class="n">raw_second_lpdu</span><span class="p">):</span>
</span><span data-line="489">                <span class="bp">self</span><span class="o">.</span><span class="n">in_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">lpdu</span><span class="p">)</span>
</span><span data-line="490">
</span><span data-line="491">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

</span><span data-line="492">
<div class="viewcode-block" id="DNP3_Link.connect">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Link.connect">[docs]</a>
</span><span data-line="493">    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="494"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Connect the socket to the specified peer address.</span>
</span><span data-line="495">
</span><span data-line="496"><span class="sd">        :param address: Peer address as a tuple of (host, port).</span>
</span><span data-line="497"><span class="sd">        :type address: tuple[str, int]</span>
</span><span data-line="498"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="499">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
</span><span data-line="500">            <span class="k">return</span>
</span><span data-line="501">
</span><span data-line="502">        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span><span data-line="503">        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="504">        <span class="bp">self</span><span class="o">.</span><span class="n">_valid</span> <span class="o">=</span> <span class="kc">True</span></div>

</span><span data-line="505">
<div class="viewcode-block" id="DNP3_Link.close">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Link.close">[docs]</a>
</span><span data-line="506">    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="507"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the underlying socket connection.&quot;&quot;&quot;</span>
</span><span data-line="508">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
</span><span data-line="509">            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="510">            <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="511">            <span class="bp">self</span><span class="o">.</span><span class="n">_valid</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>

</span><span data-line="512">
</span><span data-line="513">
<div class="viewcode-block" id="DNP3_Transport">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Transport">[docs]</a>
</span><span data-line="514"><span class="k">class</span><span class="w"> </span><span class="nc">DNP3_Transport</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
</span><span data-line="515"><span class="w">    </span><span class="sd">&quot;&quot;&quot;DNP3 Transport Layer implementation.</span>
</span><span data-line="516">
</span><span data-line="517"><span class="sd">    This class implements the transport layer of the DNP3 protocol, providing</span>
</span><span data-line="518"><span class="sd">    fragmentation and reassembly of Application Protocol Data Units (APDUs)</span>
</span><span data-line="519"><span class="sd">    into Transport Protocol Data Units (TPDUs). It sits above the Link Layer</span>
</span><span data-line="520"><span class="sd">    (:class:`DNP3_Link`) and ensures that application data is transmitted in</span>
</span><span data-line="521"><span class="sd">    compliance with the transport rules defined in the DNP3 standard.</span>
</span><span data-line="522">
</span><span data-line="523"><span class="sd">    Key responsibilities of this layer include:</span>
</span><span data-line="524">
</span><span data-line="525"><span class="sd">    * Fragmenting application data into transport segments (1-249 octets each).</span>
</span><span data-line="526"><span class="sd">    * Wrapping each fragment into a TPDU with proper sequence numbering.</span>
</span><span data-line="527"><span class="sd">    * Reassembling received TPDUs into complete APDUs.</span>
</span><span data-line="528"><span class="sd">    * Detecting and handling unsolicited responses, optionally invoking a</span>
</span><span data-line="529"><span class="sd">      user-provided callback.</span>
</span><span data-line="530">
</span><span data-line="531"><span class="sd">    :param link: The link layer object that provides LPDU transmission and reception.</span>
</span><span data-line="532"><span class="sd">    :type link: DNP3_Link</span>
</span><span data-line="533"><span class="sd">    :param unsolicited_callback: Optional callback function invoked when an unsolicited</span>
</span><span data-line="534"><span class="sd">        response APDU is received from the outstation.</span>
</span><span data-line="535"><span class="sd">    :type unsolicited_callback: Callable[[APDU], None] | None</span>
</span><span data-line="536"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="537">
</span><span data-line="538">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="539">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="540">        <span class="n">link</span><span class="p">:</span> <span class="n">DNP3_Link</span><span class="p">,</span>
</span><span data-line="541">        <span class="n">unsolicited_callback</span><span class="p">:</span> <span class="n">_UnsolicitedResponseCallback</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="542">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="543">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="544">        <span class="bp">self</span><span class="o">.</span><span class="n">__link</span> <span class="o">=</span> <span class="n">link</span>
</span><span data-line="545">        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">unsolicited_callback</span>
</span><span data-line="546">        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="547">        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
</span><span data-line="548">        <span class="bp">self</span><span class="o">.</span><span class="n">_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
</span><span data-line="549">
</span><span data-line="550">    <span class="nd">@property</span>
</span><span data-line="551">    <span class="k">def</span><span class="w"> </span><span class="nf">link</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DNP3_Link</span><span class="p">:</span>
</span><span data-line="552"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the underlying link layer object.</span>
</span><span data-line="553">
</span><span data-line="554"><span class="sd">        :return: The active :class:`DNP3_Link` instance.</span>
</span><span data-line="555"><span class="sd">        :rtype: DNP3_Link</span>
</span><span data-line="556"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="557">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__link</span>
</span><span data-line="558">
<div class="viewcode-block" id="DNP3_Transport.connect">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Transport.connect">[docs]</a>
</span><span data-line="559">    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="560"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish a connection through the link layer.</span>
</span><span data-line="561">
</span><span data-line="562"><span class="sd">        This method delegates the connection setup to the underlying</span>
</span><span data-line="563"><span class="sd">        :class:`DNP3_Link` object, updating the transport connection state.</span>
</span><span data-line="564">
</span><span data-line="565"><span class="sd">        :param address: A tuple containing the IP address and port number of the outstation.</span>
</span><span data-line="566"><span class="sd">        :type address: tuple[str, int]</span>
</span><span data-line="567"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="568">        <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span><span data-line="569">        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
</span><span data-line="570">        <span class="bp">self</span><span class="o">.</span><span class="n">_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span></div>

</span><span data-line="571">
<div class="viewcode-block" id="DNP3_Transport.close">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Transport.close">[docs]</a>
</span><span data-line="572">    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="573"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the transport connection.</span>
</span><span data-line="574">
</span><span data-line="575"><span class="sd">        This method closes the link layer connection and updates the</span>
</span><span data-line="576"><span class="sd">        internal connection status.</span>
</span><span data-line="577"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="578">        <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="579">        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
</span><span data-line="580">        <span class="bp">self</span><span class="o">.</span><span class="n">_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span></div>

</span><span data-line="581">
<div class="viewcode-block" id="DNP3_Transport.next_sequence">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Transport.next_sequence">[docs]</a>
</span><span data-line="582">    <span class="k">def</span><span class="w"> </span><span class="nf">next_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span data-line="583"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the next transport sequence number.</span>
</span><span data-line="584">
</span><span data-line="585"><span class="sd">        The transport layer maintains an internal 6-bit sequence counter</span>
</span><span data-line="586"><span class="sd">        used for ordering TPDUs. After reaching the maximum value, the</span>
</span><span data-line="587"><span class="sd">        counter wraps around to zero.</span>
</span><span data-line="588">
</span><span data-line="589"><span class="sd">        :return: The current transport sequence number before incrementing.</span>
</span><span data-line="590"><span class="sd">        :rtype: int</span>
</span><span data-line="591"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="592">        <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span>
</span><span data-line="593">        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TPDU_SEQUENCE_MAX</span>
</span><span data-line="594">        <span class="k">return</span> <span class="n">sequence</span></div>

</span><span data-line="595">
<div class="viewcode-block" id="DNP3_Transport.send_data">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Transport.send_data">[docs]</a>
</span><span data-line="596">    <span class="k">def</span><span class="w"> </span><span class="nf">send_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">octets</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="597"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Send application data through the transport layer.</span>
</span><span data-line="598">
</span><span data-line="599"><span class="sd">        This method fragments the given application data into one or more</span>
</span><span data-line="600"><span class="sd">        TPDUs (each up to 249 octets). Each TPDU is assigned sequence</span>
</span><span data-line="601"><span class="sd">        numbers and FIR/FIN flags. The fragments are then transmitted via</span>
</span><span data-line="602"><span class="sd">        the link layer.</span>
</span><span data-line="603">
</span><span data-line="604"><span class="sd">        :param octets: The application data bytes to transmit.</span>
</span><span data-line="605"><span class="sd">        :type octets: bytes</span>
</span><span data-line="606"><span class="sd">        :raises ConnectionError: If the transport connection is not established.</span>
</span><span data-line="607"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="608">        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_connected</span><span class="p">()</span>
</span><span data-line="609">        <span class="c1"># Rule 1: Each transport segment may contain 1 to 249 Application Layer data octets.</span>
</span><span data-line="610">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">octets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TPDU_APPLICATION_MAX_LENGTH</span><span class="p">:</span>
</span><span data-line="611">            <span class="n">fragments</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="612">                <span class="n">octets</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">octets</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="n">TPDU_APPLICATION_MAX_LENGTH</span><span class="p">)]</span>
</span><span data-line="613">                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">octets</span><span class="p">),</span> <span class="n">TPDU_APPLICATION_MAX_LENGTH</span><span class="p">)</span>
</span><span data-line="614">            <span class="p">]</span>
</span><span data-line="615">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="616">            <span class="n">fragments</span> <span class="o">=</span> <span class="p">[</span><span class="n">octets</span><span class="p">]</span>
</span><span data-line="617">
</span><span data-line="618">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fragment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fragments</span><span class="p">):</span>
</span><span data-line="619">            <span class="n">tpdu</span> <span class="o">=</span> <span class="n">TPDU</span><span class="p">()</span>
</span><span data-line="620">            <span class="n">tpdu</span><span class="o">.</span><span class="n">first_segment</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span>
</span><span data-line="621">            <span class="n">tpdu</span><span class="o">.</span><span class="n">final_segment</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragments</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span data-line="622">            <span class="n">tpdu</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_sequence</span><span class="p">()</span>
</span><span data-line="623">            <span class="n">tpdu</span><span class="o">.</span><span class="n">app_fragment</span> <span class="o">=</span> <span class="n">fragment</span>
</span><span data-line="624">            <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">tpdu</span><span class="p">))</span></div>

</span><span data-line="625">
<div class="viewcode-block" id="DNP3_Transport.recv_data">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Transport.recv_data">[docs]</a>
</span><span data-line="626">    <span class="k">def</span><span class="w"> </span><span class="nf">recv_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span data-line="627"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Receive and reassemble application data from the transport layer.</span>
</span><span data-line="628">
</span><span data-line="629"><span class="sd">        This method collects one or more TPDUs received from the link layer</span>
</span><span data-line="630"><span class="sd">        and reconstructs the original APDU. It validates transport sequence</span>
</span><span data-line="631"><span class="sd">        numbers to ensure proper ordering. Unsolicited responses are detected</span>
</span><span data-line="632"><span class="sd">        and optionally passed to the callback without being returned to the caller.</span>
</span><span data-line="633">
</span><span data-line="634"><span class="sd">        :return: The fully reassembled APDU bytes.</span>
</span><span data-line="635"><span class="sd">        :rtype: bytes</span>
</span><span data-line="636"><span class="sd">        :raises ConnectionError: If the transport connection is not established.</span>
</span><span data-line="637"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="638">        <span class="n">fragments</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="639">        <span class="n">more_follows</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="640">        <span class="n">sequence</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="641">        <span class="k">while</span> <span class="n">more_follows</span><span class="p">:</span>
</span><span data-line="642">            <span class="n">lpdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">recv_lpdu</span><span class="p">()</span>
</span><span data-line="643">            <span class="n">tpdu</span> <span class="o">=</span> <span class="n">lpdu</span><span class="o">.</span><span class="n">tpdu</span>
</span><span data-line="644">            <span class="k">if</span> <span class="n">tpdu</span><span class="o">.</span><span class="n">first_segment</span> <span class="ow">and</span> <span class="n">tpdu</span><span class="o">.</span><span class="n">final_segment</span><span class="p">:</span>
</span><span data-line="645">                <span class="k">if</span> <span class="n">tpdu</span><span class="o">.</span><span class="n">apdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">unsolicited_response</span><span class="p">:</span>
</span><span data-line="646">                    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span data-line="647">                        <span class="n">TRACE</span><span class="p">,</span>
</span><span data-line="648">                        <span class="s2">&quot;[TRANSPORT] Received unsolicited response with sequence &quot;</span>
</span><span data-line="649">                        <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> - ignoring...&quot;</span><span class="p">,</span>
</span><span data-line="650">                        <span class="n">tpdu</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span>
</span><span data-line="651">                    <span class="p">)</span>
</span><span data-line="652">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">:</span>
</span><span data-line="653">                        <span class="k">try</span><span class="p">:</span>
</span><span data-line="654">                            <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">tpdu</span><span class="o">.</span><span class="n">apdu</span><span class="p">)</span>
</span><span data-line="655">                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="656">                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span data-line="657">                                <span class="s2">&quot;[TRANSPORT] Error while processing unsolicited &quot;</span>
</span><span data-line="658">                                <span class="o">+</span> <span class="s2">&quot;response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span data-line="659">                                <span class="n">e</span><span class="p">,</span>
</span><span data-line="660">                            <span class="p">)</span>
</span><span data-line="661">                    <span class="k">continue</span>
</span><span data-line="662">
</span><span data-line="663">            <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span data-line="664">                <span class="n">TRACE</span><span class="p">,</span>
</span><span data-line="665">                <span class="s2">&quot;[TRANSPORT] Received TPDU with sequence </span><span class="si">%d</span><span class="s2">, FIR: </span><span class="si">%s</span><span class="s2">, FIN: </span><span class="si">%s</span><span class="s2">, &quot;</span>
</span><span data-line="666">                <span class="o">+</span> <span class="s2">&quot;size: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span data-line="667">                <span class="n">tpdu</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span>
</span><span data-line="668">                <span class="n">tpdu</span><span class="o">.</span><span class="n">first_segment</span><span class="p">,</span>
</span><span data-line="669">                <span class="n">tpdu</span><span class="o">.</span><span class="n">final_segment</span><span class="p">,</span>
</span><span data-line="670">                <span class="nb">len</span><span class="p">(</span><span class="n">tpdu</span><span class="o">.</span><span class="n">app_fragment</span><span class="p">),</span>
</span><span data-line="671">            <span class="p">)</span>
</span><span data-line="672">            <span class="k">if</span> <span class="n">sequence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="673">                <span class="n">sequence</span> <span class="o">=</span> <span class="n">tpdu</span><span class="o">.</span><span class="n">sequence</span>
</span><span data-line="674">
</span><span data-line="675">            <span class="k">if</span> <span class="n">tpdu</span><span class="o">.</span><span class="n">sequence</span> <span class="o">!=</span> <span class="n">sequence</span><span class="p">:</span>
</span><span data-line="676">                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span data-line="677">                    <span class="n">TRACE</span><span class="p">,</span>
</span><span data-line="678">                    <span class="s2">&quot;[TRANSPORT] Received unexpected TPDU with sequence </span><span class="si">%d</span><span class="s2">, &quot;</span>
</span><span data-line="679">                    <span class="o">+</span> <span class="s2">&quot;expected </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span data-line="680">                    <span class="n">tpdu</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span>
</span><span data-line="681">                    <span class="n">sequence</span><span class="p">,</span>
</span><span data-line="682">                <span class="p">)</span>
</span><span data-line="683">                <span class="k">continue</span>
</span><span data-line="684">
</span><span data-line="685">            <span class="k">if</span> <span class="n">tpdu</span><span class="o">.</span><span class="n">final_segment</span><span class="p">:</span>
</span><span data-line="686">                <span class="n">more_follows</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="687">
</span><span data-line="688">            <span class="n">fragments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpdu</span><span class="o">.</span><span class="n">app_fragment</span><span class="p">)</span>
</span><span data-line="689">            <span class="n">sequence</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="690">
</span><span data-line="691">        <span class="n">apdu_octets</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fragments</span><span class="p">)</span>
</span><span data-line="692">        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">TRACE</span><span class="p">,</span> <span class="s2">&quot;[TRANSPORT] Reassembled APDU in </span><span class="si">%d</span><span class="s2"> bytes&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">apdu_octets</span><span class="p">))</span>
</span><span data-line="693">        <span class="k">return</span> <span class="n">apdu_octets</span></div>
</div>

</span><span data-line="694">
</span><span data-line="695">
<div class="viewcode-block" id="DNP3_Master">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Master">[docs]</a>
</span><span data-line="696"><span class="k">class</span><span class="w"> </span><span class="nc">DNP3_Master</span><span class="p">:</span>
</span><span data-line="697"><span class="w">    </span><span class="sd">&quot;&quot;&quot;DNP3 Master (Application Layer interface).</span>
</span><span data-line="698">
</span><span data-line="699"><span class="sd">    This class provides the master-side interface of the DNP3 protocol stack,</span>
</span><span data-line="700"><span class="sd">    built on top of the transport and link layers. It manages request/response</span>
</span><span data-line="701"><span class="sd">    exchanges with an outstation, schedules tasks, and assigns application</span>
</span><span data-line="702"><span class="sd">    sequence numbers. The master does not implement actual application logic </span>
</span><span data-line="703"><span class="sd">    instead, it delegates handling to user-defined :class:`DNP3_Task` objects.</span>
</span><span data-line="704">
</span><span data-line="705"><span class="sd">    This implementation supports:</span>
</span><span data-line="706">
</span><span data-line="707"><span class="sd">    * Establishing and releasing associations with outstations.</span>
</span><span data-line="708"><span class="sd">    * Submitting tasks that generate and transmit APDUs.</span>
</span><span data-line="709"><span class="sd">    * Assigning and cycling application sequence numbers.</span>
</span><span data-line="710"><span class="sd">    * Supporting both blocking and non-blocking request patterns.</span>
</span><span data-line="711"><span class="sd">    * Optionally dispatching requests without expecting a return</span>
</span><span data-line="712"><span class="sd">      (:meth:`submit_noreturn`).</span>
</span><span data-line="713">
</span><span data-line="714"><span class="sd">    Example::</span>
</span><span data-line="715">
</span><span data-line="716"><span class="sd">        master = DNP3_Master(link_addr=0x0001)</span>
</span><span data-line="717"><span class="sd">        # connect to remote at 127.0.0.1:20000 with link addr 1024</span>
</span><span data-line="718"><span class="sd">        master.associate((1024, &quot;127.0.0.1&quot;, 20000))</span>
</span><span data-line="719">
</span><span data-line="720"><span class="sd">        # request class 1 objects</span>
</span><span data-line="721"><span class="sd">        objects = new_class_data_request(1)</span>
</span><span data-line="722"><span class="sd">        result = master.request(FunctionCode.READ, objects)</span>
</span><span data-line="723">
</span><span data-line="724"><span class="sd">    :param link_addr: The source link-layer address of the master.</span>
</span><span data-line="725"><span class="sd">    :type link_addr: int</span>
</span><span data-line="726"><span class="sd">    :param initial_seq: Optional initial application sequence number.</span>
</span><span data-line="727"><span class="sd">        Defaults to ``0`` if not provided.</span>
</span><span data-line="728"><span class="sd">    :type initial_seq: int | None</span>
</span><span data-line="729"><span class="sd">    :param sock: Optional socket to bind the link layer to. If omitted,</span>
</span><span data-line="730"><span class="sd">        a new socket will be created when associating with an outstation.</span>
</span><span data-line="731"><span class="sd">    :type sock: socket.socket | None</span>
</span><span data-line="732"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="733">
</span><span data-line="734">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="735">        <span class="bp">self</span><span class="p">,</span> <span class="n">link_addr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">initial_seq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="736">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="737">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span data-line="738">        <span class="bp">self</span><span class="o">.</span><span class="n">__link_addr</span> <span class="o">=</span> <span class="n">link_addr</span>
</span><span data-line="739">        <span class="bp">self</span><span class="o">.</span><span class="n">__transport</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="740">        <span class="bp">self</span><span class="o">.</span><span class="n">__tasks</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="741">        <span class="bp">self</span><span class="o">.</span><span class="n">__sequence</span> <span class="o">=</span> <span class="n">initial_seq</span> <span class="ow">or</span> <span class="mi">0</span>
</span><span data-line="742">        <span class="bp">self</span><span class="o">.</span><span class="n">__background</span> <span class="o">=</span> <span class="n">DNP3_Background</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="743">        <span class="bp">self</span><span class="o">.</span><span class="n">__socket</span> <span class="o">=</span> <span class="n">sock</span>
</span><span data-line="744">        <span class="bp">self</span><span class="o">.</span><span class="n">_valid</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="745">
</span><span data-line="746">    <span class="nd">@property</span>
</span><span data-line="747">    <span class="k">def</span><span class="w"> </span><span class="nf">tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Collection</span><span class="p">[</span><span class="n">DNP3_Task</span><span class="p">]:</span>
</span><span data-line="748"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the currently registered tasks.</span>
</span><span data-line="749">
</span><span data-line="750"><span class="sd">        :return: A collection of active tasks indexed by sequence number.</span>
</span><span data-line="751"><span class="sd">        :rtype: Collection[DNP3_Task]</span>
</span><span data-line="752"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="753">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tasks</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span data-line="754">
</span><span data-line="755">    <span class="nd">@property</span>
</span><span data-line="756">    <span class="k">def</span><span class="w"> </span><span class="nf">transport</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DNP3_Transport</span><span class="p">:</span>
</span><span data-line="757"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the transport layer instance.</span>
</span><span data-line="758">
</span><span data-line="759"><span class="sd">        :return: The active :class:`DNP3_Transport` object.</span>
</span><span data-line="760"><span class="sd">        :rtype: DNP3_Transport</span>
</span><span data-line="761"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="762">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transport</span>
</span><span data-line="763">
</span><span data-line="764">    <span class="nd">@property</span>
</span><span data-line="765">    <span class="k">def</span><span class="w"> </span><span class="nf">sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span data-line="766"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current application sequence number.</span>
</span><span data-line="767">
</span><span data-line="768"><span class="sd">        The sequence number is incremented and wrapped automatically</span>
</span><span data-line="769"><span class="sd">        whenever a request is submitted.</span>
</span><span data-line="770">
</span><span data-line="771"><span class="sd">        :return: The current APDU sequence number.</span>
</span><span data-line="772"><span class="sd">        :rtype: int</span>
</span><span data-line="773"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="774">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sequence</span>
</span><span data-line="775">
<div class="viewcode-block" id="DNP3_Master.get_task">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Master.get_task">[docs]</a>
</span><span data-line="776">    <span class="k">def</span><span class="w"> </span><span class="nf">get_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DNP3_Task</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="777"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a task by its sequence number.</span>
</span><span data-line="778">
</span><span data-line="779"><span class="sd">        :param sequence: The sequence number of the task to fetch.</span>
</span><span data-line="780"><span class="sd">        :type sequence: int</span>
</span><span data-line="781"><span class="sd">        :return: The corresponding :class:`DNP3_Task`, or ``None`` if not found.</span>
</span><span data-line="782"><span class="sd">        :rtype: DNP3_Task | None</span>
</span><span data-line="783"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="784">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tasks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span></div>

</span><span data-line="785">
<div class="viewcode-block" id="DNP3_Master.pop_task">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Master.pop_task">[docs]</a>
</span><span data-line="786">    <span class="k">def</span><span class="w"> </span><span class="nf">pop_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DNP3_Task</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="787"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove and return a task by its sequence number.</span>
</span><span data-line="788">
</span><span data-line="789"><span class="sd">        :param sequence: The sequence number of the task to remove.</span>
</span><span data-line="790"><span class="sd">        :type sequence: int</span>
</span><span data-line="791"><span class="sd">        :return: The removed :class:`DNP3_Task`, or ``None`` if not found.</span>
</span><span data-line="792"><span class="sd">        :rtype: DNP3_Task | None</span>
</span><span data-line="793"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="794">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

</span><span data-line="795">
<div class="viewcode-block" id="DNP3_Master.associate">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Master.associate">[docs]</a>
</span><span data-line="796">    <span class="k">def</span><span class="w"> </span><span class="nf">associate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="797"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish an association with an outstation.</span>
</span><span data-line="798">
</span><span data-line="799"><span class="sd">        This method sets up the underlying link and transport layers,</span>
</span><span data-line="800"><span class="sd">        connects to the given host/port, and starts background processing</span>
</span><span data-line="801"><span class="sd">        of incoming messages.</span>
</span><span data-line="802">
</span><span data-line="803"><span class="sd">        :param address: A tuple of the form ``(link_addr, host, port)``.</span>
</span><span data-line="804"><span class="sd">        :type address: tuple[int, str, int]</span>
</span><span data-line="805"><span class="sd">        :raises ValueError: If the provided address tuple is invalid.</span>
</span><span data-line="806"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="807">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid</span><span class="p">:</span>
</span><span data-line="808">            <span class="k">return</span>
</span><span data-line="809">
</span><span data-line="810">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
</span><span data-line="811">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid address - expected (link_addr, host, port)&quot;</span><span class="p">)</span>
</span><span data-line="812">
</span><span data-line="813">        <span class="n">link_dst</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">address</span>
</span><span data-line="814">        <span class="bp">self</span><span class="o">.</span><span class="n">__transport</span> <span class="o">=</span> <span class="n">DNP3_Transport</span><span class="p">(</span>
</span><span data-line="815">            <span class="n">DNP3_Link</span><span class="p">(</span><span class="n">sock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__socket</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__link_addr</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">link_dst</span><span class="p">)</span>
</span><span data-line="816">        <span class="p">)</span>
</span><span data-line="817">        <span class="bp">self</span><span class="o">.</span><span class="n">__transport</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span data-line="818">        <span class="bp">self</span><span class="o">.</span><span class="n">_valid</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="819">        <span class="bp">self</span><span class="o">.</span><span class="n">__background</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

</span><span data-line="820">
<div class="viewcode-block" id="DNP3_Master.release">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Master.release">[docs]</a>
</span><span data-line="821">    <span class="k">def</span><span class="w"> </span><span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="822"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Release the association with the outstation.</span>
</span><span data-line="823">
</span><span data-line="824"><span class="sd">        This method stops the background thread, closes the transport</span>
</span><span data-line="825"><span class="sd">        connection, and invalidates the master instance.</span>
</span><span data-line="826">
</span><span data-line="827"><span class="sd">        :param timeout: Optional timeout (in seconds) to wait for the</span>
</span><span data-line="828"><span class="sd">            background thread to join.</span>
</span><span data-line="829"><span class="sd">        :type timeout: float | None</span>
</span><span data-line="830"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="831">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid</span><span class="p">:</span>
</span><span data-line="832">            <span class="bp">self</span><span class="o">.</span><span class="n">__background</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span><span data-line="833">            <span class="bp">self</span><span class="o">.</span><span class="n">__background</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span data-line="834">            <span class="bp">self</span><span class="o">.</span><span class="n">__transport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="835">            <span class="bp">self</span><span class="o">.</span><span class="n">_valid</span> <span class="o">=</span> <span class="kc">False</span></div>

</span><span data-line="836">
<div class="viewcode-block" id="DNP3_Master.submit_task">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Master.submit_task">[docs]</a>
</span><span data-line="837">    <span class="k">def</span><span class="w"> </span><span class="nf">submit_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">DNP3_Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="838"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Submit a task and register it for response handling.</span>
</span><span data-line="839">
</span><span data-line="840"><span class="sd">        The task will be assigned the current application sequence number,</span>
</span><span data-line="841"><span class="sd">        which is then incremented. The request APDU is built by the task</span>
</span><span data-line="842"><span class="sd">        and transmitted through the transport layer.</span>
</span><span data-line="843">
</span><span data-line="844"><span class="sd">        :param task: The task to be submitted.</span>
</span><span data-line="845"><span class="sd">        :type task: DNP3_Task</span>
</span><span data-line="846"><span class="sd">        :raises ConnectionError: If the task fails to produce a valid APDU.</span>
</span><span data-line="847"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="848">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid</span><span class="p">:</span>
</span><span data-line="849">            <span class="k">raise</span> <span class="n">ConnectionNotEstablished</span><span class="p">(</span><span class="s2">&quot;Not associated with an outstation&quot;</span><span class="p">)</span>
</span><span data-line="850">
</span><span data-line="851">        <span class="bp">self</span><span class="o">.</span><span class="n">__tasks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
</span><span data-line="852">        <span class="n">task</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span>
</span><span data-line="853">        <span class="n">apdu</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">prepare_transmit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="854">        <span class="k">if</span> <span class="n">apdu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="855">            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Unable to build APDU for task&quot;</span><span class="p">)</span>
</span><span data-line="856">
</span><span data-line="857">        <span class="n">apdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span>
</span><span data-line="858">        <span class="bp">self</span><span class="o">.</span><span class="n">__sequence</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">APDU_SEQ_MAX</span>
</span><span data-line="859">        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">apdu</span><span class="p">))</span></div>

</span><span data-line="860">
<div class="viewcode-block" id="DNP3_Master.submit_noreturn">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Master.submit_noreturn">[docs]</a>
</span><span data-line="861">    <span class="k">def</span><span class="w"> </span><span class="nf">submit_noreturn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">DNP3_Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="862"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Submit a task without expecting a response.</span>
</span><span data-line="863">
</span><span data-line="864"><span class="sd">        Unlike :meth:`submit_task`, the task is not registered for later</span>
</span><span data-line="865"><span class="sd">        lookup, meaning no response will be matched or delivered.</span>
</span><span data-line="866">
</span><span data-line="867"><span class="sd">        :param task: The task to be submitted.</span>
</span><span data-line="868"><span class="sd">        :type task: DNP3_Task</span>
</span><span data-line="869"><span class="sd">        :raises ConnectionError: If the task fails to produce a valid APDU.</span>
</span><span data-line="870"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="871">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid</span><span class="p">:</span>
</span><span data-line="872">            <span class="k">raise</span> <span class="n">ConnectionNotEstablished</span><span class="p">(</span><span class="s2">&quot;Not associated with an outstation&quot;</span><span class="p">)</span>
</span><span data-line="873">
</span><span data-line="874">        <span class="n">apdu</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">prepare_transmit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="875">        <span class="k">if</span> <span class="n">apdu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="876">            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Unable to build APDU for task&quot;</span><span class="p">)</span>
</span><span data-line="877">
</span><span data-line="878">        <span class="n">apdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span>
</span><span data-line="879">        <span class="bp">self</span><span class="o">.</span><span class="n">__sequence</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">APDU_SEQ_MAX</span>
</span><span data-line="880">        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">apdu</span><span class="p">))</span></div>

</span><span data-line="881">
<div class="viewcode-block" id="DNP3_Master.transmit">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Master.transmit">[docs]</a>
</span><span data-line="882">    <span class="k">def</span><span class="w"> </span><span class="nf">transmit</span><span class="p">(</span>
</span><span data-line="883">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="884">        <span class="n">request</span><span class="p">:</span> <span class="n">APDU</span><span class="p">,</span>
</span><span data-line="885">        <span class="n">block</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="886">        <span class="n">callback</span><span class="p">:</span> <span class="n">_APDUCallback</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="887">        <span class="n">noreturn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="888">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">APDU</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="889"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transmit a request APDU to the outstation.</span>
</span><span data-line="890">
</span><span data-line="891"><span class="sd">        This method provides both blocking and non-blocking transmission</span>
</span><span data-line="892"><span class="sd">        modes. In blocking mode, it waits for the corresponding response</span>
</span><span data-line="893"><span class="sd">        before returning. In non-blocking mode, the provided callback will</span>
</span><span data-line="894"><span class="sd">        be invoked when the response is received.</span>
</span><span data-line="895">
</span><span data-line="896"><span class="sd">        :param request: The APDU to transmit.</span>
</span><span data-line="897"><span class="sd">        :type request: APDU</span>
</span><span data-line="898"><span class="sd">        :param block: Whether to wait for the response. Defaults to ``True``.</span>
</span><span data-line="899"><span class="sd">        :type block: bool</span>
</span><span data-line="900"><span class="sd">        :param callback: Optional callback to invoke with the response in</span>
</span><span data-line="901"><span class="sd">            non-blocking mode.</span>
</span><span data-line="902"><span class="sd">        :type callback: Callable[[&quot;DNP3_Master&quot;, APDU], None] | None</span>
</span><span data-line="903"><span class="sd">        :param noreturn: If ``True``, the request is sent without expecting</span>
</span><span data-line="904"><span class="sd">            a response.</span>
</span><span data-line="905"><span class="sd">        :type noreturn: bool</span>
</span><span data-line="906"><span class="sd">        :return: The received APDU if in blocking mode, otherwise ``None``.</span>
</span><span data-line="907"><span class="sd">        :rtype: APDU | None</span>
</span><span data-line="908"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="909">        <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
</span><span data-line="910">            <span class="n">message_received</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
</span><span data-line="911">            <span class="n">task</span> <span class="o">=</span> <span class="n">BlockingTask</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message_received</span><span class="p">)</span>
</span><span data-line="912">            <span class="bp">self</span><span class="o">.</span><span class="n">submit_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span data-line="913">            <span class="n">task</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span><span data-line="914">            <span class="k">return</span> <span class="n">task</span><span class="o">.</span><span class="n">message</span>
</span><span data-line="915">
</span><span data-line="916">        <span class="n">task</span> <span class="o">=</span> <span class="n">NonBlockingTask</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
</span><span data-line="917">        <span class="k">if</span> <span class="n">noreturn</span><span class="p">:</span>
</span><span data-line="918">            <span class="bp">self</span><span class="o">.</span><span class="n">submit_noreturn</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span data-line="919">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="920">            <span class="bp">self</span><span class="o">.</span><span class="n">submit_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></div>

</span><span data-line="921">
<div class="viewcode-block" id="DNP3_Master.request">
<a class="viewcode-back" href="../../../../protocols/dnp3/api/master.html#icspacket.proto.dnp3.master.DNP3_Master.request">[docs]</a>
</span><span data-line="922">    <span class="k">def</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span>
</span><span data-line="923">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="924">        <span class="n">function</span><span class="p">:</span> <span class="n">FunctionCode</span><span class="p">,</span>
</span><span data-line="925">        <span class="n">objects</span><span class="p">:</span> <span class="n">DNP3Objects</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="926">        <span class="n">need_confirm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="927">        <span class="n">block</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span data-line="928">        <span class="n">callback</span><span class="p">:</span> <span class="n">_APDUCallback</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span data-line="929">        <span class="n">noreturn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span data-line="930">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">APDU</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="931"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build and transmit a request APDU.</span>
</span><span data-line="932">
</span><span data-line="933"><span class="sd">        This is the high-level entry point for sending function code requests</span>
</span><span data-line="934"><span class="sd">        to an outstation. Optionally, objects can be included, confirmation</span>
</span><span data-line="935"><span class="sd">        can be requested, and the call may be synchronous or asynchronous.</span>
</span><span data-line="936">
</span><span data-line="937"><span class="sd">        :param function: The DNP3 application function code.</span>
</span><span data-line="938"><span class="sd">        :type function: FunctionCode</span>
</span><span data-line="939"><span class="sd">        :param objects: Optional collection of DNP3 objects to include.</span>
</span><span data-line="940"><span class="sd">        :type objects: DNP3Objects | None</span>
</span><span data-line="941"><span class="sd">        :param need_confirm: Whether a confirmation is required.</span>
</span><span data-line="942"><span class="sd">        :type need_confirm: bool</span>
</span><span data-line="943"><span class="sd">        :param block: Whether to wait for the response.</span>
</span><span data-line="944"><span class="sd">        :type block: bool</span>
</span><span data-line="945"><span class="sd">        :param callback: Callback to invoke in asynchronous mode.</span>
</span><span data-line="946"><span class="sd">        :type callback: Callable[[&quot;DNP3_Master&quot;, APDU], None] | None</span>
</span><span data-line="947"><span class="sd">        :param noreturn: If ``True``, send without expecting a response.</span>
</span><span data-line="948"><span class="sd">        :type noreturn: bool</span>
</span><span data-line="949"><span class="sd">        :return: The APDU response in blocking mode, otherwise ``None``.</span>
</span><span data-line="950"><span class="sd">        :rtype: APDU | None</span>
</span><span data-line="951"><span class="sd">        :raises ValueError: If both ``need_confirm`` and ``noreturn`` are set.</span>
</span><span data-line="952"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="953">        <span class="n">apdu</span> <span class="o">=</span> <span class="n">APDU</span><span class="p">()</span>
</span><span data-line="954">        <span class="n">apdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span>
</span><span data-line="955">        <span class="n">apdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">first_fragment</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="956">        <span class="n">apdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">final_fragment</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="957">        <span class="n">apdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">need_confirmation</span> <span class="o">=</span> <span class="n">need_confirm</span>
</span><span data-line="958">        <span class="k">if</span> <span class="n">need_confirm</span> <span class="ow">and</span> <span class="n">noreturn</span><span class="p">:</span>
</span><span data-line="959">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify both need_confirm and noreturn&quot;</span><span class="p">)</span>
</span><span data-line="960">
</span><span data-line="961">        <span class="n">apdu</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span>
</span><span data-line="962">        <span class="k">if</span> <span class="n">objects</span><span class="p">:</span>
</span><span data-line="963">            <span class="n">apdu</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="n">pack_objects</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
</span><span data-line="964">
</span><span data-line="965">        <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
</span><span data-line="966">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transmit</span><span class="p">(</span><span class="n">apdu</span><span class="p">)</span>
</span><span data-line="967">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="968">            <span class="bp">self</span><span class="o">.</span><span class="n">transmit</span><span class="p">(</span><span class="n">apdu</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span> <span class="n">noreturn</span><span class="o">=</span><span class="n">noreturn</span><span class="p">)</span>
</span><span data-line="969">            <span class="k">return</span> <span class="kc">None</span></div>
</div>

</span><span data-line="970">
</span><span data-line="971">
</span><span data-line="972"><span class="k">class</span><span class="w"> </span><span class="nc">DNP3_Background</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span><span data-line="973"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Background listener thread for a DNP3 master.</span>
</span><span data-line="974">
</span><span data-line="975"><span class="sd">    This thread continuously receives octets from the master&#39;s transport</span>
</span><span data-line="976"><span class="sd">    layer, parses them into APDUs, and dispatches the results to the</span>
</span><span data-line="977"><span class="sd">    corresponding task based on the application sequence number.</span>
</span><span data-line="978">
</span><span data-line="979"><span class="sd">    The listener operates in daemon mode, meaning it will not prevent</span>
</span><span data-line="980"><span class="sd">    application shutdown. It is started automatically by</span>
</span><span data-line="981"><span class="sd">    :meth:`DNP3_Master.associate` and terminated by</span>
</span><span data-line="982"><span class="sd">    :meth:`DNP3_Master.release`.</span>
</span><span data-line="983">
</span><span data-line="984"><span class="sd">    :param master: The :class:`DNP3_Master` instance that owns this background</span>
</span><span data-line="985"><span class="sd">        listener.</span>
</span><span data-line="986"><span class="sd">    :type master: DNP3_Master</span>
</span><span data-line="987"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="988">
</span><span data-line="989">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">master</span><span class="p">:</span> <span class="n">DNP3_Master</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="990">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="991">        <span class="bp">self</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span>
</span><span data-line="992">        <span class="c1">#: Event flag used to signal termination of the thread.</span>
</span><span data-line="993">        <span class="c1">#: :type: threading.Event</span>
</span><span data-line="994">        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
</span><span data-line="995">
</span><span data-line="996">    <span class="nd">@override</span>
</span><span data-line="997">    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="998"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Thread entry point.</span>
</span><span data-line="999">
</span><span data-line="1000"><span class="sd">        This method repeatedly reads data from the master&#39;s transport layer</span>
</span><span data-line="1001"><span class="sd">        until :attr:`stop` is set or a connection error occurs. Each received</span>
</span><span data-line="1002"><span class="sd">        frame is decoded into an :class:`APDU`. If the APDU is not an</span>
</span><span data-line="1003"><span class="sd">        unsolicited response, it is delivered to the task registered under</span>
</span><span data-line="1004"><span class="sd">        the APDU&#39;s sequence number.</span>
</span><span data-line="1005"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1006">        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
</span><span data-line="1007">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="1008">                <span class="n">octets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">recv_data</span><span class="p">()</span>
</span><span data-line="1009">            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">ConnectionError</span><span class="p">):</span>
</span><span data-line="1010">                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span><span data-line="1011">                <span class="k">break</span>
</span><span data-line="1012">
</span><span data-line="1013">            <span class="n">apdu</span> <span class="o">=</span> <span class="n">APDU</span><span class="o">.</span><span class="n">from_octets</span><span class="p">(</span><span class="n">octets</span><span class="p">)</span>
</span><span data-line="1014">            <span class="k">if</span> <span class="n">apdu</span><span class="o">.</span><span class="n">function</span> <span class="o">!=</span> <span class="n">FunctionCode</span><span class="o">.</span><span class="n">UNSOLICITED_RESPONSE</span><span class="p">:</span>
</span><span data-line="1015">                <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">pop_task</span><span class="p">(</span><span class="n">apdu</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span>
</span><span data-line="1016">                <span class="k">if</span> <span class="n">task</span><span class="p">:</span>
</span><span data-line="1017">                    <span class="n">task</span><span class="o">.</span><span class="n">on_message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">,</span> <span class="n">apdu</span><span class="p">)</span>
</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, MatrixEditor</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials">
<a href="https://github.com/MatrixEditor/icspacket" aria-label="GitHub">
  <iconify-icon icon="simple-icons:github"></iconify-icon>
</a></div>
    </div>
  </div>
</footer>
      <script src="../../../../_static/documentation_options.js?v=644960da"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../../../_static/shibuya.js?v=e730760c"></script></body>
</html>